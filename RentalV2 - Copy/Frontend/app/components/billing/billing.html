<div class="container-fluid" ng-hide="printMode">
    <div ng-if="loading" class="loader-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Billing & Invoices</h2>
        <div class="btn-group">
            <button class="btn btn-primary" ng-click="openGenerateBill()">
                <i class="fas fa-plus"></i> Generate Bill
            </button>
            <button class="btn btn-success" ng-click="openBulkGenerate()">
                <i class="fas fa-layer-group"></i> Bulk Generate
            </button>
        </div>
    </div>

    <!-- Bulk Generation Success Alert -->
    <div class="alert alert-success alert-dismissible fade show" ng-if="bulkMessage">
        <i class="fas fa-check-circle"></i> {{ bulkMessage }}
        <button type="button" class="btn-close" ng-click="bulkMessage = null"></button>
    </div>

    <!-- Outstanding Bills -->
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">Outstanding Bills</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Tenant</th>
                            <th>Room</th>
                            <th>Period</th>
                            <th>Amount Due</th>
                            <th>Due Date</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in outstandingBills">
                            <td>{{ bill.billNumber }}</td>
                            <td>{{ bill.tenant.firstName }} {{ bill.tenant.lastName }}</td>
                            <td>{{ bill.room.roomNumber }}</td>
                            <td>{{ bill.billPeriod }}</td>
                            <td class="text-danger fw-bold">{{ bill.outstandingAmount | currency:'₹' }}</td>
                            <td>{{ bill.dueDate | date }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" ng-click="printBill(bill)">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </td>
                        </tr>
                        <tr ng-if="outstandingBills.length === 0">
                            <td colspan="7" class="text-center">No outstanding bills!</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Bills -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Recent Bill History</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Bill #</th>
                            <th>Tenant</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in bills | limitTo:10">
                            <td>{{ bill.billNumber }}</td>
                            <td>{{ bill.tenant.firstName }} {{ bill.tenant.lastName }}</td>
                            <td>{{ bill.billDate | date }}</td>
                            <td>{{ bill.totalAmount | currency:'₹' }}</td>
                            <td>
                                <span class="badge"
                                    ng-class="{'bg-success': bill.status === 'Paid', 'bg-warning': bill.status === 'Pending'}">
                                    {{ bill.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" ng-click="printBill(bill)">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Generate Bill Modal -->
<div class="modal fade" id="generateBillModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-file-invoice"></i> Generate New Bill</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form ng-submit="generateBill()">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Select Room</label>
                            <select class="form-select" ng-model="newBill.roomId" ng-change="onRoomSelect()" required>
                                <option value="">-- Select Room --</option>
                                <option ng-repeat="room in rooms" value="{{room.id}}">
                                    {{room.roomNumber}} - {{room.tenant || 'Vacant'}}
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Bill Period</label>
                            <input type="month" class="form-control" ng-model="newBill.billPeriod" required>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">Monthly Rent (₹)</label>
                            <input type="number" class="form-control" ng-model="newBill.rentAmount" required>
                        </div>

                        <!-- Meter Reading Section -->
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="fas fa-bolt text-warning"></i> Electric Meter
                                        Reading</h6>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Previous Reading</label>
                                            <input type="number" class="form-control" ng-model="newBill.prevReading"
                                                ng-change="calculateElectric()" placeholder="e.g. 1200">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Current Reading</label>
                                            <input type="number" class="form-control" ng-model="newBill.currReading"
                                                ng-change="calculateElectric()" placeholder="e.g. 1350">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Units Consumed</label>
                                            <input type="text" class="form-control" readonly
                                                value="{{newBill.unitsConsumed || 0}} units @ ₹{{electricRate}}/unit">
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <strong>Electric Charges: ₹{{ newBill.electricAmount || 0 }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Misc Charges (₹)</label>
                            <input type="number" class="form-control" ng-model="newBill.miscAmount" placeholder="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Due Date</label>
                            <input type="date" class="form-control" ng-model="newBill.dueDate" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Remarks</label>
                            <textarea class="form-control" ng-model="newBill.remarks" rows="2"></textarea>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Bill Summary</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td>Rent</td>
                                    <td class="text-end">₹{{ newBill.rentAmount || 0 }}</td>
                                </tr>
                                <tr>
                                    <td>Electric</td>
                                    <td class="text-end">₹{{ newBill.electricAmount || 0 }}</td>
                                </tr>
                                <tr>
                                    <td>Misc</td>
                                    <td class="text-end">₹{{ newBill.miscAmount || 0 }}</td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>Total</strong></td>
                                    <td class="text-end"><strong>₹{{ (newBill.rentAmount || 0) + (newBill.electricAmount
                                            || 0) + (newBill.miscAmount || 0) }}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="text-end mt-3">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Generate
                            Bill</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Generate with Meter Readings Modal -->
<div class="modal fade" id="bulkGenerateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Bulk Generate Bills with Meter Readings</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Bill Period</label>
                        <input type="month" class="form-control" ng-model="bulkBill.billPeriod" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Due Date</label>
                        <input type="date" class="form-control" ng-model="bulkBill.dueDate" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Rate per Unit (₹)</label>
                        <input type="number" class="form-control" ng-model="electricRate" readonly>
                    </div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Enter current meter readings for each occupied room. Previous
                    readings are pre-filled from last recorded values.
                </div>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 80px;">Room</th>
                                <th>Tenant</th>
                                <th style="width: 100px;">Rent (₹)</th>
                                <th style="width: 100px;">Prev Reading</th>
                                <th style="width: 100px;">Current</th>
                                <th style="width: 80px;">Units</th>
                                <th style="width: 100px;">Electric (₹)</th>
                                <th style="width: 100px;">Total (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="room in bulkRooms" ng-if="room.isOccupied">
                                <td><strong>{{ room.roomNumber }}</strong></td>
                                <td>{{ room.tenantName }}</td>
                                <td>{{ room.monthlyRent | number }}</td>
                                <td>
                                    <input type="number" class="form-control form-control-sm"
                                        ng-model="room.prevReading" readonly style="width: 80px;">
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm"
                                        ng-model="room.currReading" ng-change="calculateBulkElectric(room)"
                                        placeholder="Enter" style="width: 80px;">
                                </td>
                                <td>{{ room.unitsConsumed || 0 }}</td>
                                <td>{{ room.electricCharges || 0 | number }}</td>
                                <td><strong>{{ room.totalBill || room.monthlyRent | number }}</strong></td>
                            </tr>
                        </tbody>
                        <tfoot class="table-success">
                            <tr>
                                <td colspan="2"><strong>TOTAL</strong></td>
                                <td><strong>{{ getTotalRent() | number }}</strong></td>
                                <td colspan="2"></td>
                                <td><strong>{{ getTotalUnits() }}</strong></td>
                                <td><strong>{{ getTotalElectric() | number }}</strong></td>
                                <td><strong>{{ getGrandTotal() | number }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="text-end mt-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-success me-2" ng-click="generateBulkBillsRentOnly()"
                        ng-disabled="bulkGenerating">
                        <i class="fas fa-file-invoice"></i> Generate Rent Only
                    </button>
                    <button type="button" class="btn btn-success" ng-click="generateBulkBillsWithReadings()"
                        ng-disabled="bulkGenerating">
                        <span ng-if="!bulkGenerating"><i class="fas fa-bolt"></i> Generate with Readings</span>
                        <span ng-if="bulkGenerating"><i class="fas fa-spinner fa-spin"></i> Generating...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PRINT VIEW (Visible only in Print Mode) -->
<div class="container bg-white p-5" ng-show="printMode" style="max-width: 210mm; margin: 0 auto;">
    <div class="d-print-none mb-4">
        <button class="btn btn-secondary" ng-click="closePrint()"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn btn-primary ms-2" onclick="window.print()"><i class="fas fa-print"></i> Print Now</button>
    </div>

    <!-- Inline Styles for Print -->
    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            .sidebar,
            .navbar {
                display: none !important;
            }

            .container.bg-white,
            .container.bg-white * {
                visibility: visible;
            }

            .container.bg-white {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
            }

            .d-print-none {
                display: none !important;
            }
        }
    </style>

    <div class="text-center mb-5">
        <h1>INVOICE</h1>
        <h3>Sita Devi Pandey and Sons</h3>
        <p>11/1B/1 GANPAT RAI KHEMKA LANE LILUAH HOWRAH(W. B.) 711204</p>
    </div>

    <div class="row mb-4">
        <div class="col-6">
            <h5>Bill To:</h5>
            <p>
                <strong>{{ selectedBillForPrint.tenant.firstName }} {{ selectedBillForPrint.tenant.lastName
                    }}</strong><br>
                Room: {{ selectedBillForPrint.room.roomNumber }}<br>
                {{ selectedBillForPrint.tenant.phoneNumber }}
            </p>
        </div>
        <div class="col-6 text-end">
            <p>
                <strong>Invoice #:</strong> {{ selectedBillForPrint.billNumber }}<br>
                <strong>Date:</strong> {{ selectedBillForPrint.billDate | date }}<br>
                <strong>Due Date:</strong> {{ selectedBillForPrint.dueDate | date }}<br>
                <strong>Period:</strong> {{ selectedBillForPrint.billPeriod }}
            </p>
        </div>
    </div>

    <table class="table table-bordered border-dark">
        <thead class="table-light">
            <tr>
                <th>Description</th>
                <th class="text-end">Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Monthly Rent - Room {{ selectedBillForPrint.room.roomNumber }}</td>
                <td class="text-end">{{ selectedBillForPrint.rentAmount | currency:'₹' }}</td>
            </tr>
            <tr ng-if="selectedBillForPrint.electricAmount > 0">
                <td>Electric Charges
                    <small class="d-block text-muted">
                        Reading: {{ selectedBillForPrint.electricMeterReading.previousReading }} to {{
                        selectedBillForPrint.electricMeterReading.currentReading }}
                        (Units: {{ selectedBillForPrint.electricMeterReading.currentReading -
                        selectedBillForPrint.electricMeterReading.previousReading }})
                    </small>
                </td>
                <td class="text-end">{{ selectedBillForPrint.electricAmount | currency:'₹' }}</td>
            </tr>
            <tr ng-if="selectedBillForPrint.miscAmount > 0">
                <td>Miscellaneous Charges</td>
                <td class="text-end">{{ selectedBillForPrint.miscAmount | currency:'₹' }}</td>
            </tr>
            <tr ng-repeat="item in selectedBillForPrint.billItems">
                <td>{{ item.description }}</td>
                <td class="text-end">{{ item.amount | currency:'₹' }}</td>
            </tr>
        </tbody>
        <tfoot class="table-light">
            <tr>
                <td class="text-end"><strong>Total Amount</strong></td>
                <td class="text-end"><strong>{{ selectedBillForPrint.totalAmount | currency:'₹' }}</strong></td>
            </tr>
        </tfoot>
    </table>

    <div class="mt-5">
        <p><strong>Remarks:</strong> {{ selectedBillForPrint.remarks || 'No additional remarks.' }}</p>
    </div>

    <div class="mt-5 pt-5 text-center">
        <p>__________________________</p>
        <p>Signature</p>
    </div>
</div>