<div class="container-fluid" ng-hide="printMode">
    <div ng-if="loading" class="loader-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Billing & Ledger</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-success" ng-click="generateBills()" ng-disabled="loading">
                <i class="fas fa-magic me-1"></i> Generate Bills
            </button>
            <button class="btn btn-outline-primary" ng-click="printAllBills()"
                ng-disabled="loading || bills.length === 0">
                <i class="fas fa-print me-1"></i> Print All Invoices
            </button>
        </div>
    </div>

    <!-- Outstanding Bills -->
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">Outstanding Balances</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ref #</th>
                            <th>Tenant</th>
                            <th>Room</th>
                            <th>Period</th>
                            <th>Amount Due</th>
                            <th>Paid</th>
                            <th>Outstanding</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in outstandingBills">
                            <td>{{ bill.billNumber }}</td>
                            <td>{{ bill.tenantName }}</td>
                            <td>{{ bill.roomNumber }}</td>
                            <td>{{ bill.billPeriod }}</td>
                            <td>₹{{ bill.totalAmount | number }}</td>
                            <td class="text-success">₹{{ bill.paidAmount | number }}</td>
                            <td class="text-danger fw-bold">₹{{ bill.outstandingAmount | number }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" ng-click="printBill(bill)">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </td>
                        </tr>
                        <tr ng-if="outstandingBills.length === 0">
                            <td colspan="8" class="text-center text-success"><i class="fas fa-check-circle"></i> No
                                outstanding balances!</td>
                        </tr>
                    </tbody>
                    <tfoot ng-if="outstandingBills.length > 0">
                        <tr class="table-danger">
                            <td colspan="6" class="text-end"><strong>Total Outstanding:</strong></td>
                            <td><strong>₹{{ getTotalOutstanding() | number }}</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Ledger Entries -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Recent Ledger Entries</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ref #</th>
                            <th>Tenant</th>
                            <th>Room</th>
                            <th>Period</th>
                            <th>Readings</th>
                            <th>Rent</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in bills | limitTo:20">
                            <td>{{ bill.billNumber }}</td>
                            <td>{{ bill.tenantName }}</td>
                            <td>{{ bill.roomNumber }}</td>
                            <td>{{ bill.billPeriod }}</td>
                            <td>
                                <div class="input-group input-group-sm" style="width: 120px;">
                                    <input type="number" class="form-control" ng-model="bill.elecNew"
                                        placeholder="Reading">
                                    <button class="btn btn-outline-secondary" type="button"
                                        ng-click="updateReading(bill)" title="Save Details">
                                        <i class="fas fa-save"></i>
                                    </button>
                                </div>
                                <small class="text-muted" ng-if="bill.elecPrev">Prev: {{bill.elecPrev}}</small>
                            </td>
                            <td>
                                <div class="input-group input-group-sm" style="width: 100px;">
                                    <span class="input-group-text">₹</span>
                                    <input type="number" class="form-control" ng-model="bill.monthlyRent"
                                        placeholder="Rent">
                                </div>
                                <small class="text-muted" ng-if="bill.totalAmount">Total: {{bill.totalAmount |
                                    number}}</small>
                            </td>
                            <td>₹{{ bill.totalAmount | number }}</td>
                            <td class="text-success">₹{{ bill.paidAmount | number }}</td>
                            <td>
                                <span class="badge"
                                    ng-class="{'bg-success': bill.status === 'Paid', 'bg-warning': bill.status === 'Pending'}">
                                    {{ bill.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" ng-click="printBill(bill)">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PRINT VIEW -->
<div class="container bg-white p-5" ng-show="printMode" style="max-width: 210mm; margin: 0 auto;">
    <div class="d-print-none mb-4">
        <button class="btn btn-secondary" ng-click="closePrint()"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn btn-primary ms-2" onclick="window.print()"><i class="fas fa-print"></i> Print Now</button>
    </div>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            .sidebar,
            .navbar {
                display: none !important;
            }

            .container.bg-white,
            .container.bg-white * {
                visibility: visible;
            }

            .container.bg-white {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
            }

            .d-print-none {
                display: none !important;
            }
        }
    </style>

    <div ng-repeat="bill in billsToPrint"
        class="print-page mb-5 pb-5 border-bottom border-secondary d-print-border-none">
        <div class="text-center mb-5">
            <h1>INVOICE</h1>
            <h3>Sita Devi Pandey and Sons</h3>
            <p>11/1B/1 GANPAT RAI KHEMKA LANE LILUAH HOWRAH(W. B.) 711204</p>
        </div>

        <div class="row mb-4">
            <div class="col-6">
                <h5>Bill To:</h5>
                <p>
                    <strong>{{ bill.tenantName }}</strong><br>
                    Room: {{ bill.roomNumber }}
                </p>
            </div>
            <div class="col-6 text-end">
                <p>
                    <strong>Invoice #:</strong> {{ bill.billNumber }}<br>
                    <strong>Period:</strong> {{ bill.billPeriod }}
                </p>
            </div>
        </div>

        <table class="table table-bordered border-dark">
            <thead class="table-light">
                <tr>
                    <th>Description</th>
                    <th class="text-end">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Monthly Rent - Room {{ bill.roomNumber }}</td>
                    <td class="text-end">₹{{ bill.monthlyRent || bill.totalAmount | number }}</td>
                </tr>
                <tr ng-if="bill.elecNew > 0 || bill.elecPrev > 0">
                    <td>
                        Electric Charges <br>
                        <small class="text-muted">
                            (Reading: {{bill.elecNew}} - {{bill.elecPrev}} = {{bill.elecUnits}} units @
                            ₹{{bill.elecRate}}/unit)
                        </small>
                    </td>
                    <td class="text-end">₹{{ bill.electricAmount | number }}</td>
                </tr>
                <tr ng-if="bill.miscAmount > 0">
                    <td>Miscellaneous Charges</td>
                    <td class="text-end">₹{{ bill.miscAmount | number }}</td>
                </tr>
                <tr ng-if="bill.carryover > 0">
                    <td>Arrears / Carryover</td>
                    <td class="text-end">₹{{ bill.carryover | number }}</td>
                </tr>
            </tbody>
            <tfoot class="table-light">
                <tr>
                    <td class="text-end"><strong>Total Amount</strong></td>
                    <td class="text-end"><strong>₹{{ bill.totalAmount | number }}</strong></td>
                </tr>
                <tr ng-if="bill.paidAmount > 0">
                    <td class="text-end"><strong>Amount Paid</strong></td>
                    <td class="text-end text-success"><strong>₹{{ bill.paidAmount | number }}</strong></td>
                </tr>
                <tr ng-if="bill.closingBalance > 0">
                    <td class="text-end"><strong>Balance Due</strong></td>
                    <td class="text-end text-danger"><strong>₹{{ bill.closingBalance | number }}</strong>
                    </td>
                </tr>
            </tfoot>
        </table>

        <div class="mt-5">
            <p><strong>Remarks:</strong> {{ bill.remarks || 'No additional remarks.' }}</p>
        </div>

        <div class="mt-5 pt-5 text-center">
            <p>__________________________</p>
            <p>Signature</p>
        </div>

        <!-- Page break for printing -->
        <div class="page-break"></div>
    </div>
</div>