<div class="container-fluid" ng-hide="printMode">
    <div ng-if="loading" class="loader-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Billing & Ledger</h2>
    </div>

    <!-- Outstanding Bills -->
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">Outstanding Balances</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Ref #</th>
                            <th>Tenant</th>
                            <th>Room</th>
                            <th>Period</th>
                            <th>Amount Due</th>
                            <th>Paid</th>
                            <th>Outstanding</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in outstandingBills">
                            <td>{{ bill.billNumber }}</td>
                            <td>{{ bill.tenantName }}</td>
                            <td>{{ bill.roomNumber }}</td>
                            <td>{{ bill.billPeriod }}</td>
                            <td>₹{{ bill.totalAmount | number }}</td>
                            <td class="text-success">₹{{ bill.paidAmount | number }}</td>
                            <td class="text-danger fw-bold">₹{{ bill.outstandingAmount | number }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" ng-click="printBill(bill)">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </td>
                        </tr>
                        <tr ng-if="outstandingBills.length === 0">
                            <td colspan="8" class="text-center text-success"><i class="fas fa-check-circle"></i> No
                                outstanding balances!</td>
                        </tr>
                    </tbody>
                    <tfoot ng-if="outstandingBills.length > 0">
                        <tr class="table-danger">
                            <td colspan="6" class="text-end"><strong>Total Outstanding:</strong></td>
                            <td><strong>₹{{ getTotalOutstanding() | number }}</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Recent Ledger Entries -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Recent Ledger Entries</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ref #</th>
                            <th>Tenant</th>
                            <th>Room</th>
                            <th>Period</th>
                            <th>Total</th>
                            <th>Paid</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in bills | limitTo:20">
                            <td>{{ bill.billNumber }}</td>
                            <td>{{ bill.tenantName }}</td>
                            <td>{{ bill.roomNumber }}</td>
                            <td>{{ bill.billPeriod }}</td>
                            <td>₹{{ bill.totalAmount | number }}</td>
                            <td class="text-success">₹{{ bill.paidAmount | number }}</td>
                            <td>
                                <span class="badge"
                                    ng-class="{'bg-success': bill.status === 'Paid', 'bg-warning': bill.status === 'Pending'}">
                                    {{ bill.status }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" ng-click="printBill(bill)">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- PRINT VIEW -->
<div class="container bg-white p-5" ng-show="printMode" style="max-width: 210mm; margin: 0 auto;">
    <div class="d-print-none mb-4">
        <button class="btn btn-secondary" ng-click="closePrint()"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn btn-primary ms-2" onclick="window.print()"><i class="fas fa-print"></i> Print Now</button>
    </div>

    <style>
        @media print {
            body * {
                visibility: hidden;
            }

            .sidebar,
            .navbar {
                display: none !important;
            }

            .container.bg-white,
            .container.bg-white * {
                visibility: visible;
            }

            .container.bg-white {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 20px;
            }

            .d-print-none {
                display: none !important;
            }
        }
    </style>

    <div class="text-center mb-5">
        <h1>INVOICE</h1>
        <h3>Sita Devi Pandey and Sons</h3>
        <p>11/1B/1 GANPAT RAI KHEMKA LANE LILUAH HOWRAH(W. B.) 711204</p>
    </div>

    <div class="row mb-4">
        <div class="col-6">
            <h5>Bill To:</h5>
            <p>
                <strong>{{ selectedBillForPrint.tenantName }}</strong><br>
                Room: {{ selectedBillForPrint.roomNumber }}
            </p>
        </div>
        <div class="col-6 text-end">
            <p>
                <strong>Invoice #:</strong> {{ selectedBillForPrint.billNumber }}<br>
                <strong>Period:</strong> {{ selectedBillForPrint.billPeriod }}
            </p>
        </div>
    </div>

    <table class="table table-bordered border-dark">
        <thead class="table-light">
            <tr>
                <th>Description</th>
                <th class="text-end">Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Monthly Rent - Room {{ selectedBillForPrint.roomNumber }}</td>
                <td class="text-end">₹{{ selectedBillForPrint.rentAmount | number }}</td>
            </tr>
            <tr ng-if="selectedBillForPrint.electricAmount > 0">
                <td>Electric Charges</td>
                <td class="text-end">₹{{ selectedBillForPrint.electricAmount | number }}</td>
            </tr>
            <tr ng-if="selectedBillForPrint.miscAmount > 0">
                <td>Miscellaneous Charges</td>
                <td class="text-end">₹{{ selectedBillForPrint.miscAmount | number }}</td>
            </tr>
        </tbody>
        <tfoot class="table-light">
            <tr>
                <td class="text-end"><strong>Total Amount</strong></td>
                <td class="text-end"><strong>₹{{ selectedBillForPrint.totalAmount | number }}</strong></td>
            </tr>
            <tr ng-if="selectedBillForPrint.paidAmount > 0">
                <td class="text-end"><strong>Amount Paid</strong></td>
                <td class="text-end text-success"><strong>₹{{ selectedBillForPrint.paidAmount | number }}</strong></td>
            </tr>
            <tr ng-if="selectedBillForPrint.outstandingAmount > 0">
                <td class="text-end"><strong>Balance Due</strong></td>
                <td class="text-end text-danger"><strong>₹{{ selectedBillForPrint.outstandingAmount | number }}</strong>
                </td>
            </tr>
        </tfoot>
    </table>

    <div class="mt-5">
        <p><strong>Remarks:</strong> {{ selectedBillForPrint.remarks || 'No additional remarks.' }}</p>
    </div>

    <div class="mt-5 pt-5 text-center">
        <p>__________________________</p>
        <p>Signature</p>
    </div>
</div>