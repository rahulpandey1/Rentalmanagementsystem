<div class="container-fluid">
    <div ng-if="loading" class="loader-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Room Management</h2>
        <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-primary fs-6">{{ periodLabel }}</span>
            <select class="form-select w-auto" ng-model="filterFloor">
                <option value="">All Floors</option>
                <option value="0">Ground Floor</option>
                <option value="1">First Floor</option>
                <option value="2">Second Floor</option>
            </select>
            <button class="btn btn-primary" ng-click="openAddRoom()">
                <i class="fas fa-plus"></i> Add Room
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-soft-primary mb-3">
                <div class="card-body text-center">
                    <h4>{{ rooms.length }}</h4>
                    <small>Total Rooms</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-soft-success mb-3">
                <div class="card-body text-center">
                    <h4>{{ availableCount }}</h4>
                    <small>Available</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-soft-danger mb-3">
                <div class="card-body text-center">
                    <h4>{{ occupiedCount }}</h4>
                    <small>Occupied</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-soft-info mb-3">
                <div class="card-body text-center">
                    <h4>{{ unassignedTenants.length }}</h4>
                    <small>Tenants in Queue</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4 col-lg-3" ng-repeat="room in rooms | filter:filterRooms">
            <div class="card h-100 shadow-sm"
                ng-class="{'border-soft-success': room.isAvailable, 'border-soft-danger': !room.isAvailable}"
                style="border: 1px solid;">
                <div class="card-header room-card-header d-flex justify-content-between align-items-center"
                    ng-class="{'bg-soft-success': room.isAvailable, 'bg-soft-danger': !room.isAvailable}">
                    <h5 class="mb-0">{{ room.roomNumber || room.roomCode }}</h5>
                    <span class="badge" ng-class="{'bg-success': room.isAvailable, 'bg-danger': !room.isAvailable}">{{
                        room.isAvailable ? 'Available' : 'Occupied' }}</span>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Rent:</span>
                        <strong>₹{{ room.monthlyRent | number }}</strong>
                    </div>

                    <!-- Tenant Info -->
                    <div ng-if="room.currentTenant" class="mt-2 p-2 bg-light rounded">
                        <div><i class="fas fa-user text-soft-primary"></i> <strong>{{ room.currentTenant.name
                                }}</strong>
                        </div>
                        <small class="text-muted" ng-if="room.currentTenant.since">Since: {{ room.currentTenant.since
                            }}</small>
                        <div ng-if="room.currentTenant.securityDeposit">
                            <small>Security: ₹{{ room.currentTenant.securityDeposit | number }}</small>
                        </div>
                    </div>

                    <!-- Period Financials -->
                    <div class="mt-2 p-2 border rounded small" ng-if="room.totalDue > 0 || room.closingBalance > 0">
                        <div><strong>Due:</strong> ₹{{ room.totalDue | number }}</div>
                        <div><strong>Paid:</strong> <span class="text-success">₹{{ room.amountPaid | number }}</span>
                        </div>
                        <div><strong>Balance:</strong>
                            <span ng-class="{'text-danger fw-bold': room.closingBalance > 0}">₹{{ room.closingBalance |
                                number }}</span>
                        </div>
                    </div>

                    <!-- Meter Info -->
                    <div class="mt-2 p-2 border rounded small" ng-if="room.elecNew > 0">
                        <div><i class="fas fa-bolt text-soft-warning"></i> <strong>Electric:</strong>
                            {{ room.elecPrev }} → {{ room.elecNew }} ({{ room.elecUnits }} units, ₹{{ room.elecCost |
                            number }})</div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-3">
                        <button class="btn btn-sm btn-soft-primary w-100 mb-1" ng-click="viewRoomDetails(room)">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        <button class="btn btn-sm btn-soft-success w-100"
                            ng-if="room.isAvailable && unassignedTenants.length > 0" ng-click="openAssignTenant(room)">
                            <i class="fas fa-user-plus"></i> Assign Tenant
                        </button>
                        <div ng-if="!room.isAvailable" class="d-flex gap-1">
                            <button class="btn btn-sm btn-soft-warning w-50" ng-click="openRenewModal(room)"
                                title="Renew Agreement / Hike Rent">
                                <i class="fas fa-sync-alt"></i> Renew
                            </button>
                            <button class="btn btn-sm btn-soft-danger w-50" ng-click="vacateRoom(room)"
                                title="Vacate Room">
                                <i class="fas fa-sign-out-alt"></i> Vacate
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Room Modal -->
    <div class="modal fade" id="addRoomModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-soft-primary">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form ng-submit="saveNewRoom()">
                        <div class="mb-3">
                            <label class="form-label">Room Code *</label>
                            <input type="text" class="form-control" ng-model="newRoom.roomCode" required
                                placeholder="e.g. G1, F1-A, S2">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Floor</label>
                            <select class="form-select" ng-model="newRoom.floor">
                                <option value="0">Ground Floor</option>
                                <option value="1">First Floor</option>
                                <option value="2">Second Floor</option>
                            </select>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check"></i> Add Room
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Tenant Modal -->
    <div class="modal fade" id="assignTenantModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-soft-success">
                    <h5 class="modal-title"><i class="fas fa-user-plus"></i> Assign Tenant to {{ selectedRoom.roomNumber
                        || selectedRoom.roomCode }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form ng-submit="confirmAssign()">
                        <div class="mb-3">
                            <label class="form-label">Select Tenant *</label>
                            <select class="form-select" ng-model="assignment.tenantId" required>
                                <option value="">-- Select from Queue --</option>
                                <option ng-repeat="tenant in unassignedTenants"
                                    value="{{tenant.tenantId || tenant.id}}">
                                    {{ tenant.name || (tenant.firstName + ' ' + tenant.lastName) }}
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Monthly Rent (₹)</label>
                            <input type="number" class="form-control" ng-model="assignment.monthlyRent">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Security Deposit (₹)</label>
                            <input type="number" class="form-control" ng-model="assignment.securityDeposit">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" ng-model="assignment.startDate">
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Assign
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Room Details Modal -->
    <div class="modal fade" id="roomDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Room Details: {{ roomDetails.roomNumber || roomDetails.roomCode }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Basic Info</h6>
                            <p><strong>Floor:</strong> {{ roomDetails.floorNumber }}</p>
                            <p><strong>Rent:</strong> ₹{{ roomDetails.monthlyRent | number }}</p>
                            <p><strong>Status:</strong>
                                <span class="badge"
                                    ng-class="{'bg-success': roomDetails.isAvailable, 'bg-danger': !roomDetails.isAvailable}">
                                    {{ roomDetails.isAvailable ? 'Available' : 'Occupied' }}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6" ng-if="roomDetails.currentTenant">
                            <h6>Current Tenant</h6>
                            <p><strong>Name:</strong> {{ roomDetails.currentTenant.name }}</p>
                            <p><strong>Since:</strong> {{ roomDetails.currentTenant.since ||
                                (roomDetails.currentTenant.since | date:'dd MMM yyyy') }}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>Ledger History</h6>
                    <table class="table table-sm"
                        ng-if="roomDetails.meterReadingHistory && roomDetails.meterReadingHistory.length > 0">
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Rent</th>
                                <th>Elec Prev</th>
                                <th>Elec New</th>
                                <th>Units</th>
                                <th>Elec Cost</th>
                                <th>Total Due</th>
                                <th>Paid</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="entry in roomDetails.meterReadingHistory">
                                <td>{{ entry.period }}</td>
                                <td>₹{{ entry.monthlyRent | number }}</td>
                                <td>{{ entry.elecPrev }}</td>
                                <td>{{ entry.elecNew }}</td>
                                <td>{{ entry.elecUnits }}</td>
                                <td>₹{{ entry.elecCost | number }}</td>
                                <td>₹{{ entry.totalDue | number }}</td>
                                <td class="text-success">₹{{ entry.amountPaid | number }}</td>
                                <td ng-class="{'text-danger': entry.closingBalance > 0}">₹{{ entry.closingBalance |
                                    number }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p ng-if="!roomDetails.meterReadingHistory || roomDetails.meterReadingHistory.length === 0"
                        class="text-muted">
                        No ledger history.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Renew Agreement Modal -->
    <div class="modal fade" id="renewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-soft-warning">
                    <h5 class="modal-title"><i class="fas fa-sync-alt"></i> Renew / Hike Rent - {{
                        selectedRoom.roomNumber || selectedRoom.roomCode }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        This will end the current agreement and start a new one with the updated rent. History will be
                        preserved.
                    </div>
                    <form ng-submit="renewAgreement()">
                        <div class="mb-3">
                            <label class="form-label">Current Tenant</label>
                            <input type="text" class="form-control" readonly
                                value="{{ selectedRoom.currentTenant.name }}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Monthly Rent (₹)</label>
                            <input type="number" class="form-control" ng-model="renewData.monthlyRent" required>
                            <small class="text-muted">Current Rent: ₹{{ selectedRoom.monthlyRent }}</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" ng-model="renewData.startDate" required>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-check"></i> Confirm Renewal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>